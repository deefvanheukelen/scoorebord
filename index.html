<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Voetbal Scorebord</title>

<link href="https://fonts.googleapis.com/css2?family=Micro+5+Charted&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#f4f4f4; --black:#000; --red:#ff0000; --green:#28a745; --blue:#007bff; --darkred:darkred;
    --card:#fff; --card2:#fff; --gray:#333; --orange:#ff8c00;
    --yellow:#f5c400; --redcard:#c40000;
  }
  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{
    font-family: Arial, sans-serif;
    background:var(--bg);
    margin:0;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{ max-width: 560px; margin: 0 auto; padding: 10px 12px 18px; }

  /* TOP ACTIONS */
  .top-actions{
    display:grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 10px;
    margin-bottom: 10px;
    align-items: stretch;
  }

  #newMatchBtn{
    width:100%;
    border:none;
    border-radius: 10px;
    color:#fff;
    font-weight: 900;
    font-size: clamp(18px, 5vw, 26px);
    padding: 14px 0;
    touch-action: manipulation;
    background: var(--gray);
  }
  #newMatchBtn:active{ transform: translateY(1px); }

  .sub-group{
    display:grid;
    grid-template-columns: 1fr 46px 46px;
    gap: 8px;
  }
  #subBtn{
    width:100%;
    border:none;
    border-radius: 10px;
    color:#fff;
    font-weight: 900;
    font-size: clamp(18px, 5vw, 26px);
    padding: 14px 0;
    touch-action: manipulation;
    background: var(--orange);
  }
  #subBtn:active{ transform: translateY(1px); }

  .card-btn{
    border:none;
    border-radius: 10px;
    padding:0;
    touch-action: manipulation;
  }
  .card-btn:active{ transform: translateY(1px); }
  #yellowBtn{ background: var(--yellow); }
  #redBtn{ background: var(--redcard); }

  /* SCORE/TIMER */
  .top-row{
    display:grid;
    grid-template-columns: 1fr 1.3fr 1fr;
    align-items:center;
    gap: 10px;
    background:var(--black);
    padding: 14px 10px;
    width:100%;
    border-radius: 10px;
  }
  .scorebox span, #timer{
    font-family:"Micro 5 Charted", monospace;
    color:var(--red);
    text-align:center;
    display:block;
    line-height: 1;
    font-variant-numeric: tabular-nums;
    font-size: clamp(56px, 14vw, 120px);
  }
  #timer{ cursor:pointer; padding: 6px 0; user-select:none; }

  #startPauseBtn{
    background:var(--green);
    color:white;
    font-size: clamp(34px, 9vw, 55px);
    font-weight: 900;
    padding: 18px 0;
    width:100%;
    border:none;
    margin: 12px 0;
    border-radius: 10px;
    touch-action: manipulation;
  }
  #startPauseBtn:active{ transform: translateY(1px); }

  /* GOAL BUTTONS */
  .goal-container{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    width:100%;
    margin-bottom: 12px;
  }
  .goal-btn{
    background:var(--blue);
    color:white;
    font-size: clamp(24px, 6.5vw, 40px);
    padding: 16px 0;
    border:none;
    border-radius: 10px;
    text-transform: uppercase;
    line-height: 1.05;
    touch-action: manipulation;
  }
  .goal-btn:active{ transform: translateY(1px); }
  .goal-btn .goal-word{ display:block; font-weight:900; }
  .goal-btn .team-word{
    display:block;
    margin-top: 8px;
    font-weight:900;
    padding: 0 10px;
    overflow-wrap:anywhere;
  }

  /* OVERZICHT (TABLE) */
  #logWrap{ margin-top: 10px; width:100%; }
  table#logTable{
    width:100%;
    border-collapse: separate;
    border-spacing: 0 8px;
    table-layout: fixed;
  }
  #logTable td{
    background: var(--card);
    padding: 12px 10px;
    font-size: clamp(18px, 5vw, 34px);
    vertical-align: middle;
  }

  .td-info, .td-swap{
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #logTable tr:nth-child(even) td{ background: var(--card2); }
  #logTable tr td:first-child{ border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
  #logTable tr td:last-child{ border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

  #logTable col.col-min{ width: 70px; }
  #logTable col.col-score{ width: 80px; }
  #logTable col.col-info{ width: auto; }
  #logTable col.col-icon{ width: 52px; }

  .td-min{ font-weight: 900; }
  .td-score{ font-weight: 900; text-align: center; }
  .td-info{ font-weight: 900; }
  .td-swap{ font-weight: 900; }
  .swap-label{ font-weight: 400; }

  .td-icon{ text-align:center; }
  .icon-btn{
    background:none;
    border:none;
    cursor:pointer;
    padding:0;
    width: 34px;
    height: 34px;
    font-size: 24px;
    touch-action: manipulation;
  }

  /* PDF */
  #pdfBtn{
    margin-top: 14px;
    background:var(--darkred);
    color:white;
    font-size: clamp(24px, 6.5vw, 40px);
    font-weight: 900;
    border:none;
    padding: 18px 0;
    width:100%;
    border-radius: 10px;
    touch-action: manipulation;
  }
  #pdfBtn:active{ transform: translateY(1px); }

  /* POPUPS */
  .popup-bg{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.75);
    display:none;
    justify-content:center;
    align-items:center;
    padding: 16px;
    z-index:9999;
  }
  .popup{
    background:white;
    width: min(520px, 100%);
    font-size: 18px;
    border-radius: 16px;
    padding: 18px;
  }
  .popup h2{ margin: 0 0 12px; font-size: 22px; }
  .popup .hint{ color:#444; font-size: 14px; margin: -6px 0 10px; }
  .popup input, .popup select{
    width:100%;
    padding: 12px;
    font-size: 18px;
    margin-top: 8px;
    margin-bottom: 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }
  .checkrow{
    display:flex;
    align-items:center;
    gap: 10px;
    font-size: 18px;
    margin-top: 6px;
    margin-bottom: 10px;
    user-select:none;
  }
  .checkrow input{ width: 22px; height: 22px; }

  .popup button{
    font-size: 18px;
    padding: 12px;
    width:100%;
    margin-top: 10px;
    border: none;
    border-radius: 10px;
    cursor:pointer;
    touch-action: manipulation;
  }
  .btn-ok{ background: var(--green); color: #fff; font-weight: 900; }
  .btn-cancel{ background: #666; color: #fff; font-weight: 900; }
  .btn-danger{ background: #8b0000; color:#fff; font-weight: 900; }

  @media (max-width: 360px){
    #logTable col.col-min{ width: 56px; }
    #logTable col.col-score{ width: 68px; }
    #logTable col.col-icon{ width: 48px; }
    .icon-btn{ width: 32px; height: 32px; font-size: 22px; }
    .top-actions{ grid-template-columns: 1fr; }
    .sub-group{ grid-template-columns: 1fr 44px 44px; }
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="top-actions">
    <button id="newMatchBtn">Nieuwe wedstrijd</button>

    <div class="sub-group" aria-label="Wissel en kaarten">
      <button id="subBtn">Wissel</button>
      <button id="yellowBtn" class="card-btn" title="Gele kaart" aria-label="Gele kaart"></button>
      <button id="redBtn" class="card-btn" title="Rode kaart" aria-label="Rode kaart"></button>
    </div>
  </div>

  <div class="top-row">
    <div class="scorebox"><span id="scoreHome">0</span></div>
    <div id="timer">00:00</div>
    <div class="scorebox"><span id="scoreAway">0</span></div>
  </div>

  <button id="startPauseBtn">START</button>

  <div class="goal-container">
    <button class="goal-btn" onclick="openGoalPopup('home')">
      <span class="goal-word">GOAL</span>
      <span class="team-word" id="goalHomeTeamText">THUIS</span>
    </button>

    <button class="goal-btn" onclick="openGoalPopup('away')">
      <span class="goal-word">GOAL</span>
      <span class="team-word" id="goalAwayTeamText">UIT</span>
    </button>
  </div>

  <div id="logWrap">
    <table id="logTable" aria-label="Overzicht">
      <colgroup>
        <col class="col-min">
        <col class="col-score">
        <col class="col-info">
        <col class="col-icon">
        <col class="col-icon">
      </colgroup>
      <tbody id="logTbody"></tbody>
    </table>
  </div>

  <button id="pdfBtn" onclick="downloadPDF()">Download PDF</button>
</div>

<!-- MESSAGE POPUP (vervangt alert) -->
<div id="msgPopupBg" class="popup-bg">
  <div class="popup">
    <h2 id="msgTitle">Melding</h2>
    <div id="msgBody" style="font-size:18px; line-height:1.35; color:#111;"></div>
    <button class="btn-ok" onclick="closeMsg()">OK</button>
  </div>
</div>

<!-- GOAL POPUP -->
<div id="goalPopupBg" class="popup-bg">
  <div class="popup">
    <h2 id="goalPopupTitle">Geef rugnummer in</h2>
    <input id="goalNumberInput" type="number" inputmode="numeric" placeholder="Rugnummer">

    <label class="checkrow">
      <input id="goalOgCheck" type="checkbox">
      Owngoal (OG)
    </label>

    <button class="btn-ok" onclick="confirmGoal()">OK</button>
    <button class="btn-cancel" onclick="closeGoalPopup()">Annuleer</button>
  </div>
</div>

<!-- SUB POPUP -->
<div id="subPopupBg" class="popup-bg">
  <div class="popup">
    <h2>Wissel</h2>
    <div>Speler UIT (rugnr):</div>
    <input id="subOutInput" type="number" inputmode="numeric" placeholder="bv. 7">
    <div>Speler IN (rugnr):</div>
    <input id="subInInput" type="number" inputmode="numeric" placeholder="bv. 18">

    <button class="btn-ok" onclick="confirmSub()">OK</button>
    <button class="btn-cancel" onclick="closeSubPopup()">Annuleer</button>
  </div>
</div>

<!-- CARD POPUP -->
<div id="cardPopupBg" class="popup-bg">
  <div class="popup">
    <h2 id="cardTitle">Kaart</h2>
    <div class="hint" id="cardHint"></div>
    <input id="cardNumberInput" type="number" inputmode="numeric" placeholder="Rugnummer">

    <button class="btn-ok" onclick="confirmCard()">OK</button>
    <button class="btn-cancel" onclick="closeCardPopup()">Annuleer</button>
  </div>
</div>

<!-- NEW MATCH POPUP -->
<div id="newMatchPopupBg" class="popup-bg">
  <div class="popup">
    <h2>Nieuwe wedstrijd</h2>

    <div>Ploeg THUIS:</div>
    <input id="newHomeName" type="text" placeholder="bv. FC Thuis">

    <div>Ploeg UIT:</div>
    <input id="newAwayName" type="text" placeholder="bv. FC Uit">

    <button class="btn-danger" onclick="confirmNewMatch()">Start nieuwe wedstrijd</button>
    <button class="btn-cancel" onclick="closeNewMatchPopup()">Annuleer</button>
  </div>
</div>

<!-- TIME POPUP (timer instellen) -->
<div id="timePopupBg" class="popup-bg">
  <div class="popup">
    <h2>Timer instellen</h2>
    <div class="hint">Gebruik <b>mm:ss</b> (bv. 18:30) of enkel <b>minuten</b> (bv. 63)</div>
    <input id="timeInput" inputmode="numeric" placeholder="bv. 45:00">

    <button class="btn-ok" onclick="confirmTimeSet()">OK</button>
    <button class="btn-cancel" onclick="closeTimePopup()">Annuleer</button>
  </div>
</div>

<!-- EDIT POPUP -->
<div id="editPopupBg" class="popup-bg">
  <div class="popup">
    <h2 id="editTitle">Wijzig item</h2>

    <div>
      Tijd (mm:ss):
      <input id="editTime" inputmode="numeric" placeholder="bv. 18:00">
    </div>

    <div id="editTeamWrap">
      Team:
      <select id="editTeam"></select>
    </div>

    <div id="editNumberWrap">
      Rugnummer:
      <input id="editNumber" type="number" inputmode="numeric" placeholder="bv. 10">
    </div>

    <div id="editOgWrap">
      <label class="checkrow" style="margin-top:0;">
        <input id="editOgCheck" type="checkbox">
        Owngoal (OG)
      </label>
    </div>

    <div id="editSubWrap" style="display:none;">
      Speler UIT (rugnr):
      <input id="editOut" type="number" inputmode="numeric" placeholder="bv. 7">
      Speler IN (rugnr):
      <input id="editIn" type="number" inputmode="numeric" placeholder="bv. 18">
    </div>

    <div id="editCardWrap" style="display:none;">
      Type kaart:
      <select id="editCardType">
        <option value="yellow">Geel</option>
        <option value="red">Rood</option>
      </select>
      Rugnummer:
      <input id="editCardNumber" type="number" inputmode="numeric" placeholder="bv. 4">
    </div>

    <button class="btn-ok" onclick="saveEdit()">Opslaan</button>
    <button class="btn-cancel" onclick="closeEditPopup()">Annuleer</button>
  </div>
</div>

<script>
const STORAGE_KEY = "voetbal_scorebord_table_modals_cards_v1";

/* -------------------- STATE -------------------- */
let teamHomeName = "THUIS";
let teamAwayName = "UIT";

let items = [];
// goal: {type:"goal", timeSec, team, number, isOG}
// sub:  {type:"sub",  timeSec, out, in}
// card: {type:"card", timeSec, card:"yellow"|"red", number}

let home = 0;
let away = 0;

// Timer (wall clock)
let running = false;
let elapsedWhenStartedSec = 0;
let startEpochMs = null;
let uiInterval = null;

const HALF_TIME_SECONDS = 45 * 60;
let halfTimeTriggered = false;

const timerEl = document.getElementById("timer");
const tbody = document.getElementById("logTbody");

/* -------------------- MESSAGE POPUP (alert replacement) -------------------- */
function showMessage(title, body){
  document.getElementById("msgTitle").textContent = title || "Melding";
  document.getElementById("msgBody").textContent = body || "";
  document.getElementById("msgPopupBg").style.display = "flex";
}
function closeMsg(){
  document.getElementById("msgPopupBg").style.display = "none";
}

/* -------------------- SAVE/LOAD -------------------- */
function saveState(){
  const data = {
    teamHomeName, teamAwayName,
    items,
    running,
    elapsedWhenStartedSec,
    startEpochMs,
    halfTimeTriggered
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);

    if (typeof data.teamHomeName === "string") teamHomeName = data.teamHomeName;
    if (typeof data.teamAwayName === "string") teamAwayName = data.teamAwayName;
    if (Array.isArray(data.items)) items = data.items;

    running = !!data.running;
    if (Number.isFinite(data.elapsedWhenStartedSec)) elapsedWhenStartedSec = data.elapsedWhenStartedSec;
    startEpochMs = (typeof data.startEpochMs === "number") ? data.startEpochMs : null;
    halfTimeTriggered = !!data.halfTimeTriggered;

    // backward compat defaults
    for (const it of items){
      if (it.type === "goal" && typeof it.isOG !== "boolean") it.isOG = false;
      if (it.type === "card" && (it.card !== "yellow" && it.card !== "red")) it.card = "yellow";
    }

    recomputeScore();
    return true;
  }catch(e){ return false; }
}

/* -------------------- UI -------------------- */
function updateTeamUI(){
  document.getElementById("goalHomeTeamText").textContent = teamHomeName;
  document.getElementById("goalAwayTeamText").textContent = teamAwayName;

  const sel = document.getElementById("editTeam");
  sel.innerHTML = `
    <option value="home">${teamHomeName}</option>
    <option value="away">${teamAwayName}</option>
  `;
}

function updateScoreboard(){
  document.getElementById("scoreHome").textContent = home;
  document.getElementById("scoreAway").textContent = away;
}

function scoringTeamForGoal(goal){
  // jouw wens: score gaat naar team waarvan knop werd geklikt (ook bij OG)
  return goal.team;
}

function recomputeScore(){
  home = 0; away = 0;
  for (const it of items){
    if (it.type === "goal"){
      const t = scoringTeamForGoal(it);
      if (t === "home") home++;
      else away++;
    }
  }
}

function matchMinuteForLog(timeSec){
  return Math.floor(timeSec / 60) + 1; // 00:45 => 1', 63:15 => 64'
}

function formatTimer(seconds){
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return String(mins).padStart(2, "0") + ":" + String(secs).padStart(2, "0");
}

function formatTime(sec){
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

/* -------------------- OVERZICHT (TABLE) -------------------- */
function rebuildLog(){
  tbody.innerHTML = "";

  const withIndex = items.map((it, idx) => ({...it, _idx: idx}));
  withIndex.sort((a,b) => a.timeSec - b.timeSec || a._idx - b._idx);

  let h = 0, a = 0;

  for (const it of withIndex){
    if (it.type === "goal"){
      const t = scoringTeamForGoal(it);
      if (t === "home") h++; else a++;
    }

    const tr = document.createElement("tr");
    const minuteTick = matchMinuteForLog(it.timeSec);

    const tdMin = document.createElement("td");
    tdMin.className = "td-min";
    tdMin.textContent = `${minuteTick}'`;
    tr.appendChild(tdMin);

    if (it.type === "goal"){
      const tdScore = document.createElement("td");
      tdScore.className = "td-score";
      tdScore.textContent = `${h}-${a}`;
      tr.appendChild(tdScore);

      const tdInfo = document.createElement("td");
      tdInfo.className = "td-info";
      tdInfo.textContent = `#${it.number}${it.isOG ? " (OG)" : ""}`;
      tr.appendChild(tdInfo);
    }
    else if (it.type === "sub"){
      const tdSwap = document.createElement("td");
      tdSwap.className = "td-swap";
      tdSwap.colSpan = 2;
      tdSwap.innerHTML =
        `<span class="swap-label">uit:</span> #${it.out} &nbsp;&nbsp; <span class="swap-label">in:</span> #${it.in}`;
      tr.appendChild(tdSwap);
    }
    else if (it.type === "card"){
      const tdCard = document.createElement("td");
      tdCard.className = "td-swap";
      tdCard.colSpan = 2;
      const sym = (it.card === "red") ? "ðŸŸ¥" : "ðŸŸ¨";
      tdCard.textContent = `${sym} #${it.number}`;
      tr.appendChild(tdCard);
    }
    else{
      // onbekend type -> safe fallback
      const td = document.createElement("td");
      td.colSpan = 2;
      td.textContent = "-";
      tr.appendChild(td);
    }

    const tdEdit = document.createElement("td");
    tdEdit.className = "td-icon";
    const btnEdit = document.createElement("button");
    btnEdit.className = "icon-btn";
    btnEdit.type = "button";
    btnEdit.textContent = "âœŽ";
    btnEdit.addEventListener("click", () => editItem(it._idx));
    tdEdit.appendChild(btnEdit);
    tr.appendChild(tdEdit);

    const tdDel = document.createElement("td");
    tdDel.className = "td-icon";
    const btnDel = document.createElement("button");
    btnDel.className = "icon-btn";
    btnDel.type = "button";
    btnDel.textContent = "âœ–";
    btnDel.addEventListener("click", () => deleteItem(it._idx));
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    tbody.appendChild(tr);
  }
}

/* -------------------- TIMER (wall clock) -------------------- */
function getElapsedSecondsNow(){
  if (!running) return Math.max(0, Math.floor(elapsedWhenStartedSec));
  if (typeof startEpochMs !== "number"){
    startEpochMs = Date.now();
    saveState();
    return Math.max(0, Math.floor(elapsedWhenStartedSec));
  }
  const deltaSec = (Date.now() - startEpochMs) / 1000;
  return Math.max(0, Math.floor(elapsedWhenStartedSec + deltaSec));
}

function syncTimerUI(){
  const sec = getElapsedSecondsNow();
  timerEl.textContent = formatTimer(sec);

  // auto pauze 1x bij 45:00
  if (running && !halfTimeTriggered && sec >= HALF_TIME_SECONDS){
    halfTimeTriggered = true;
    saveState();
    pauseTimerAt(sec);
  }
}

function startUiInterval(){
  if (uiInterval) clearInterval(uiInterval);
  uiInterval = setInterval(syncTimerUI, 250);
}
function stopUiInterval(){
  if (uiInterval){ clearInterval(uiInterval); uiInterval = null; }
}

function startTimer(){
  if (running) return;

  const current = getElapsedSecondsNow();
  elapsedWhenStartedSec = current;
  startEpochMs = Date.now();
  running = true;

  document.getElementById("startPauseBtn").textContent = "PAUZE";
  startUiInterval();

  saveState();
  syncTimerUI();
}

function pauseTimerAt(secNow){
  running = false;
  elapsedWhenStartedSec = secNow;
  startEpochMs = null;

  document.getElementById("startPauseBtn").textContent = "START";
  stopUiInterval();

  saveState();
  syncTimerUI();
}

function pauseTimer(){ pauseTimerAt(getElapsedSecondsNow()); }

document.getElementById("startPauseBtn").onclick = function(){
  running ? pauseTimer() : startTimer();
};

function parseTimeToSeconds(input){
  const raw = String(input || "").trim();
  if (!raw) return null;

  if (/^\d+$/.test(raw)){
    const m = parseInt(raw,10);
    if (Number.isNaN(m) || m < 0) return null;
    return m * 60;
  }

  const match = raw.match(/^(\d+)\s*:\s*(\d{1,2})$/);
  if (!match) return null;

  const mm = parseInt(match[1],10);
  const ss = parseInt(match[2],10);
  if (Number.isNaN(mm) || Number.isNaN(ss) || mm < 0 || ss < 0 || ss > 59) return null;

  return mm * 60 + ss;
}

/* Timer klikken -> mooie popup */
timerEl.onclick = function(){
  const current = getElapsedSecondsNow();
  document.getElementById("timeInput").value = formatTimer(current);
  document.getElementById("timePopupBg").style.display = "flex";
  setTimeout(() => document.getElementById("timeInput").focus(), 0);
};
function closeTimePopup(){
  document.getElementById("timePopupBg").style.display = "none";
}
function confirmTimeSet(){
  const input = document.getElementById("timeInput").value;
  const sec = parseTimeToSeconds(input);

  if (sec === null){
    showMessage("Ongeldige tijd", "Gebruik mm:ss (bv. 18:30) of enkel minuten (bv. 63).");
    return;
  }

  if (sec < HALF_TIME_SECONDS) halfTimeTriggered = false;

  if (running){
    elapsedWhenStartedSec = sec;
    startEpochMs = Date.now();
  }else{
    elapsedWhenStartedSec = sec;
  }

  saveState();
  syncTimerUI();
  closeTimePopup();
}

document.addEventListener("visibilitychange", () => { if (!document.hidden) syncTimerUI(); });
window.addEventListener("pageshow", () => syncTimerUI());

/* -------------------- GOAL POPUP -------------------- */
let currentTeam = "";

function openGoalPopup(team){
  currentTeam = team;
  const teamLabel = (team === "home") ? teamHomeName : teamAwayName;
  document.getElementById("goalPopupTitle").textContent = `Goal ${teamLabel} - rugnummer`;

  document.getElementById("goalPopupBg").style.display = "flex";
  document.getElementById("goalNumberInput").value = "";
  document.getElementById("goalOgCheck").checked = false;
  setTimeout(() => document.getElementById("goalNumberInput").focus(), 0);
}
function closeGoalPopup(){ document.getElementById("goalPopupBg").style.display = "none"; }

function confirmGoal(){
  const nr = document.getElementById("goalNumberInput").value;
  if (nr === ""){
    showMessage("Invoer ontbreekt", "Geef een rugnummer in.");
    return;
  }

  const isOG = document.getElementById("goalOgCheck").checked;
  const timeSec = getElapsedSecondsNow();

  items.push({ type:"goal", timeSec, team: currentTeam, number: String(nr).trim(), isOG });

  recomputeScore();
  updateScoreboard();
  rebuildLog();
  saveState();
  closeGoalPopup();
}

/* -------------------- SUB POPUP -------------------- */
function openSubPopup(){
  document.getElementById("subPopupBg").style.display = "flex";
  document.getElementById("subOutInput").value = "";
  document.getElementById("subInInput").value = "";
  setTimeout(() => document.getElementById("subOutInput").focus(), 0);
}
function closeSubPopup(){ document.getElementById("subPopupBg").style.display = "none"; }

function confirmSub(){
  const outVal = String(document.getElementById("subOutInput").value || "").trim();
  const inVal  = String(document.getElementById("subInInput").value || "").trim();
  if (!outVal){ showMessage("Invoer ontbreekt", "Geef een rugnummer UIT in."); return; }
  if (!inVal){ showMessage("Invoer ontbreekt", "Geef een rugnummer IN in."); return; }

  const timeSec = getElapsedSecondsNow();
  items.push({ type:"sub", timeSec, out: outVal, in: inVal });

  rebuildLog();
  saveState();
  closeSubPopup();
}
document.getElementById("subBtn").addEventListener("click", openSubPopup);

/* -------------------- CARDS -------------------- */
let currentCardType = "yellow";

function openCardPopup(type){
  currentCardType = type;
  const title = (type === "red") ? "Rode kaart" : "Gele kaart";
  document.getElementById("cardTitle").textContent = title;
  document.getElementById("cardHint").textContent = "Geef het rugnummer van de speler.";
  document.getElementById("cardNumberInput").value = "";

  document.getElementById("cardPopupBg").style.display = "flex";
  setTimeout(() => document.getElementById("cardNumberInput").focus(), 0);
}
function closeCardPopup(){
  document.getElementById("cardPopupBg").style.display = "none";
}
function confirmCard(){
  const nr = String(document.getElementById("cardNumberInput").value || "").trim();
  if (!nr){
    showMessage("Invoer ontbreekt", "Geef een rugnummer in.");
    return;
  }
  const timeSec = getElapsedSecondsNow();
  items.push({ type:"card", timeSec, card: currentCardType, number: nr });

  rebuildLog();
  saveState();
  closeCardPopup();
}
document.getElementById("yellowBtn").addEventListener("click", () => openCardPopup("yellow"));
document.getElementById("redBtn").addEventListener("click", () => openCardPopup("red"));

/* -------------------- NEW MATCH POPUP -------------------- */
function openNewMatchPopup(){
  document.getElementById("newMatchPopupBg").style.display = "flex";
  document.getElementById("newHomeName").value = teamHomeName;
  document.getElementById("newAwayName").value = teamAwayName;
  setTimeout(() => document.getElementById("newHomeName").focus(), 0);
}
function closeNewMatchPopup(){ document.getElementById("newMatchPopupBg").style.display = "none"; }

function confirmNewMatch(){
  let h = String(document.getElementById("newHomeName").value || "").trim();
  let a = String(document.getElementById("newAwayName").value || "").trim();
  if (!h) h = "THUIS";
  if (!a) a = "UIT";

  // reset alles
  running = false;
  elapsedWhenStartedSec = 0;
  startEpochMs = null;
  if (uiInterval){ clearInterval(uiInterval); uiInterval = null; }

  halfTimeTriggered = false;
  items = [];
  home = 0; away = 0;

  teamHomeName = h;
  teamAwayName = a;

  updateTeamUI();
  updateScoreboard();
  rebuildLog();

  timerEl.textContent = "00:00";
  document.getElementById("startPauseBtn").textContent = "START";

  saveState();
  closeNewMatchPopup();
}
document.getElementById("newMatchBtn").addEventListener("click", openNewMatchPopup);

/* -------------------- EDIT/DELETE -------------------- */
let editIndex = null;

function editItem(index){
  editIndex = index;
  const it = items[index];

  document.getElementById("editTime").value = formatTime(it.timeSec);

  const isGoal = (it.type === "goal");
  const isSub  = (it.type === "sub");
  const isCard = (it.type === "card");

  document.getElementById("editTitle").textContent =
    isGoal ? "Wijzig doelpunt" : (isSub ? "Wijzig wissel" : "Wijzig kaart");

  document.getElementById("editTeamWrap").style.display = isGoal ? "block" : "none";
  document.getElementById("editNumberWrap").style.display = isGoal ? "block" : "none";
  document.getElementById("editOgWrap").style.display = isGoal ? "block" : "none";
  document.getElementById("editSubWrap").style.display = isSub ? "block" : "none";
  document.getElementById("editCardWrap").style.display = isCard ? "block" : "none";

  if (isGoal){
    document.getElementById("editTeam").value = it.team;
    document.getElementById("editNumber").value = it.number;
    document.getElementById("editOgCheck").checked = !!it.isOG;
  } else if (isSub){
    document.getElementById("editOut").value = it.out;
    document.getElementById("editIn").value = it.in;
  } else if (isCard){
    document.getElementById("editCardType").value = it.card;
    document.getElementById("editCardNumber").value = it.number;
  }

  document.getElementById("editPopupBg").style.display = "flex";
  setTimeout(() => document.getElementById("editTime").focus(), 0);
}

function closeEditPopup(){
  document.getElementById("editPopupBg").style.display = "none";
}

function saveEdit(){
  const it = items[editIndex];

  const newTimeSec = parseTimeToSeconds(document.getElementById("editTime").value);
  if (newTimeSec === null){
    showMessage("Ongeldige tijd", "Gebruik mm:ss (bv. 18:30) of enkel minuten (bv. 63).");
    return;
  }

  if (it.type === "goal"){
    const newTeam = document.getElementById("editTeam").value;
    const newNumber = document.getElementById("editNumber").value;
    const newIsOG = document.getElementById("editOgCheck").checked;

    if (newNumber === ""){ showMessage("Invoer demonstrkt", "Geef een rugnummer in."); return; }

    it.timeSec = newTimeSec;
    it.team = newTeam;
    it.number = String(newNumber).trim();
    it.isOG = newIsOG;

    recomputeScore();
    updateScoreboard();
    rebuildLog();
    saveState();
    closeEditPopup();
    return;
  }

  if (it.type === "sub"){
    const outVal = String(document.getElementById("editOut").value || "").trim();
    const inVal  = String(document.getElementById("editIn").value || "").trim();
    if (!outVal){ showMessage("Invoer ontbreekt", "Geef een rugnummer UIT in."); return; }
    if (!inVal){ showMessage("Invoer ontbreekt", "Geef een rugnummer IN in."); return; }

    it.timeSec = newTimeSec;
    it.out = outVal;
    it.in = inVal;

    rebuildLog();
    saveState();
    closeEditPopup();
    return;
  }

  if (it.type === "card"){
    const type = document.getElementById("editCardType").value;
    const nr = String(document.getElementById("editCardNumber").value || "").trim();
    if (!nr){ showMessage("Invoer ontbreekt", "Geef een rugnummer in."); return; }

    it.timeSec = newTimeSec;
    it.card = (type === "red") ? "red" : "yellow";
    it.number = nr;

    rebuildLog();
    saveState();
    closeEditPopup();
    return;
  }
}

function deleteItem(index){
  items.splice(index, 1);
  recomputeScore();
  updateScoreboard();
  rebuildLog();
  saveState();
}

/* -------------------- PDF: Goals + Wissels + Kaarten -------------------- */
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const marginX = 40;
  let y = 50;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Wedstrijd Overzicht", marginX, y);

  y += 24;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);

  const dateOnly = new Date().toLocaleDateString("nl-BE");
  doc.text(`Datum: ${dateOnly}`, marginX, y); y += 18;
  doc.text(`Ploegen: ${teamHomeName} (thuis) vs ${teamAwayName} (uit)`, marginX, y); y += 18;
  doc.text(`Eindstand: ${teamHomeName} ${home} - ${away} ${teamAwayName}`, marginX, y); y += 10;

  const withIndex = items.map((it, idx) => ({...it, _idx: idx}));
  withIndex.sort((a,b) => a.timeSec - b.timeSec || a._idx - b._idx);

  let h = 0, a = 0;
  const goalRows = [];
  const subRows = [];
  const cardRows = [];

  for (const it of withIndex){
    const tijd = matchMinuteForLog(it.timeSec) + "'";

    if (it.type === "goal"){
      const t = scoringTeamForGoal(it);
      if (t === "home") h++; else a++;

      const score = `${h}-${a}`;
      const rug = `#${it.number}${it.isOG ? " (OG)" : ""}`;
      goalRows.push([tijd, score, rug]);
    }
    else if (it.type === "sub"){
      subRows.push([tijd, `#${it.out}`, `#${it.in}`]);
    }
    else if (it.type === "card"){
      const cardName = (it.card === "red") ? "Rood" : "Geel";
      cardRows.push([tijd, cardName, `#${it.number}`]);
    }
  }

  y += 14;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Goals", marginX, y);

  doc.autoTable({
    startY: y + 10,
    head: [["Tijd", "Score", "Rugnr"]],
    body: goalRows.length ? goalRows : [["-", "-", "-"]],
    styles: { font: "helvetica", fontSize: 11, cellPadding: 6 },
    headStyles: { fillColor: [30, 30, 30] },
    margin: { left: marginX, right: marginX }
  });

  y = doc.lastAutoTable.finalY + 18;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Wissels", marginX, y);

  doc.autoTable({
    startY: y + 10,
    head: [["Tijd", "Uit", "In"]],
    body: subRows.length ? subRows : [["-", "-", "-"]],
    styles: { font: "helvetica", fontSize: 11, cellPadding: 6 },
    headStyles: { fillColor: [30, 30, 30] },
    margin: { left: marginX, right: marginX }
  });

  y = doc.lastAutoTable.finalY + 18;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Kaarten", marginX, y);

  doc.autoTable({
    startY: y + 10,
    head: [["Tijd", "Kaart", "Rugnr"]],
    body: cardRows.length ? cardRows : [["-", "-", "-"]],
    styles: { font: "helvetica", fontSize: 11, cellPadding: 6 },
    headStyles: { fillColor: [30, 30, 30] },
    margin: { left: marginX, right: marginX }
  });

  doc.save("wedstrijd.pdf");
}

/* Anti per ongeluk sluiten/refresh */
window.addEventListener("beforeunload", (e) => {
  e.preventDefault();
  e.returnValue = "";
});

/* INIT */
(function init(){
  loadState();
  updateTeamUI();
  recomputeScore();
  updateScoreboard();
  rebuildLog();

  document.getElementById("startPauseBtn").textContent = running ? "PAUZE" : "START";
  if (running) startUiInterval();
  syncTimerUI();
})();
</script>
</body>
</html>
